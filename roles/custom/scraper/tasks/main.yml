- name: Install Python
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
  apt: name={{ item }} state=present update_cache=yes
  with_items:
    - postgresql-client
    - libpq-dev
    - libxml2-dev
    - libxslt1-dev
    - redis-tools
    - redis-server
    - ffmpeg

- name: git clone from ikeikeikeike/panglao-scraper.git
  sudo_user: "{{ username }}"
  git:
    repo: git@github.com:ikeikeikeike/panglao-scraper.git
    dest: "/home/{{ username }}/panglao-scraper"
    version: master
    update: yes
    accept_hostkey: yes

- name: setup install
  sudo_user: "{{ username }}"
  shell: |
    cd /home/{{ username }}/panglao-scraper &&
    /home/{{ username }}/venv/bin/python setup.py install

- name: migrate cheapcdn
  sudo_user: "{{ username }}"
  shell: |
    cd /home/{{ username }}/panglao-scraper/scraper &&
    DJANGO_SETTINGS_MODULE=scraper.settings_production /home/{{ username }}/venv/bin/python manage.py migrate &&
    DJANGO_SETTINGS_MODULE=scraper.settings_production /home/{{ username }}/venv/bin/python manage.py migrate cheapcdn --database=cheapcdn
